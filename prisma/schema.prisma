// ============================================
// FILE: prisma/schema.prisma (UPDATED FOR PRISMA 7)
// ============================================
generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTHENTICATION & USERS
// ============================================

enum UserRole {
  OWNER
  AGENT
  CARETAKER
  TENANT
  SECURITY
  GARDENER
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  TRIAL
}

enum SubscriptionPlan {
  OWNER_BASIC
  OWNER_PREMIUM
  AGENT_BASIC
  AGENT_PREMIUM
}

model User {
  id       String   @id @default(cuid())
  email    String   @unique
  password String
  name     String
  phone    String?
  role     UserRole @default(OWNER)

  subscription Subscription?

  ownedProperties     Property[]           @relation("PropertyOwner")
  agentProperties     Property[]           @relation("PropertyAgent")
  caretakerProperties Property[]           @relation("PropertyCaretaker")
  tenantLeases        Lease[]
  payments            Payment[]
  maintenanceRequests MaintenanceRequest[]
  incidents           Incident[]
  assignments         Assignment[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  @@index([email])
  @@index([role])
}

model Subscription {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  plan   SubscriptionPlan
  status SubscriptionStatus @default(TRIAL)

  paystackCustomerCode     String?
  paystackSubscriptionCode String?
  paystackPlanCode         String?

  amount       Float
  currency     String @default("KES")
  billingCycle String @default("monthly")

  startDate       DateTime  @default(now())
  endDate         DateTime?
  nextBillingDate DateTime?
  cancelledAt     DateTime?

  trialEndsAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

enum PropertyType {
  APARTMENT
  HOUSE
  COMMERCIAL
  MIXED
}

model Property {
  id          String       @id @default(cuid())
  name        String
  description String?
  type        PropertyType @default(APARTMENT)

  address String
  city    String
  county  String?
  country String  @default("Kenya")

  totalUnits Int
  floors     Int?
  yearBuilt  Int?
  amenities  String[] @default([])

  ownerId String
  owner   User   @relation("PropertyOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  agentId String?
  agent   User?   @relation("PropertyAgent", fields: [agentId], references: [id])

  caretakerId String?
  caretaker   User?   @relation("PropertyCaretaker", fields: [caretakerId], references: [id])

  units               Unit[]
  maintenanceRequests MaintenanceRequest[]
  incidents           Incident[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@index([agentId])
}

enum UnitStatus {
  VACANT
  OCCUPIED
  MAINTENANCE
}

model Unit {
  id         String @id @default(cuid())
  unitNumber String

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  bedrooms   Int
  bathrooms  Float
  squareFeet Int?
  floor      Int?

  rentAmount    Float
  depositAmount Float?

  status UnitStatus @default(VACANT)

  leases        Lease[]
  meterReadings MeterReading[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([propertyId, unitNumber])
  @@index([propertyId])
  @@index([status])
}

model Lease {
  id String @id @default(cuid())

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  tenantId String
  tenant   User   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  startDate   DateTime
  endDate     DateTime
  moveInDate  DateTime?
  moveOutDate DateTime?

  rentAmount    Float
  depositAmount Float
  depositPaid   Boolean @default(false)

  active Boolean @default(true)

  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([unitId])
  @@index([tenantId])
  @@index([active])
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  MPESA
  PAYSTACK
  BANK_TRANSFER
  CASH
  CHEQUE
}

model Payment {
  id String @id @default(cuid())

  leaseId String
  lease   Lease  @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  tenantId String
  tenant   User   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  amount Float
  method PaymentMethod
  status PaymentStatus @default(PENDING)

  dueDate  DateTime
  paidDate DateTime?

  referenceNumber   String?
  paystackReference String?
  mpesaCode         String?

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([leaseId])
  @@index([tenantId])
  @@index([status])
  @@index([dueDate])
}

enum MaintenancePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum MaintenanceStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model MaintenanceRequest {
  id String @id @default(cuid())

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  reportedById String
  reportedBy   User   @relation(fields: [reportedById], references: [id])

  title       String
  description String
  priority    MaintenancePriority @default(MEDIUM)
  status      MaintenanceStatus   @default(PENDING)

  assignedTo String?

  reportedAt  DateTime  @default(now())
  completedAt DateTime?

  estimatedCost Float?
  actualCost    Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([propertyId])
  @@index([reportedById])
  @@index([status])
  @@index([priority])
}

enum MeterType {
  ELECTRICITY
  WATER
  GAS
}

model MeterReading {
  id String @id @default(cuid())

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  type MeterType

  previousReading Float
  currentReading  Float
  consumption     Float

  ratePerUnit Float?
  amount      Float?

  readingDate DateTime @default(now())

  createdAt DateTime @default(now())

  @@index([unitId])
  @@index([type])
  @@index([readingDate])
}

enum IncidentType {
  SECURITY_BREACH
  THEFT
  VANDALISM
  DISTURBANCE
  UNAUTHORIZED_ACCESS
  SUSPICIOUS_ACTIVITY
  OTHER
}

enum IncidentSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum IncidentStatus {
  REPORTED
  INVESTIGATING
  RESOLVED
  CLOSED
}

model Incident {
  id String @id @default(cuid())

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  reportedById String
  reportedBy   User   @relation(fields: [reportedById], references: [id])

  type     IncidentType
  severity IncidentSeverity @default(MEDIUM)
  status   IncidentStatus   @default(REPORTED)

  title       String
  description String
  location    String

  occurredAt DateTime
  reportedAt DateTime  @default(now())
  resolvedAt DateTime?

  actionTaken String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([propertyId])
  @@index([reportedById])
  @@index([status])
  @@index([severity])
}

enum AssignmentType {
  GARDENING
  SECURITY_PATROL
  CLEANING
  INSPECTION
  MAINTENANCE
  OTHER
}

enum AssignmentStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model Assignment {
  id String @id @default(cuid())

  assignedToId String
  assignedTo   User   @relation(fields: [assignedToId], references: [id], onDelete: Cascade)

  type   AssignmentType
  status AssignmentStatus @default(PENDING)

  title       String
  description String?
  location    String?

  scheduledDate DateTime
  startedAt     DateTime?
  completedAt   DateTime?

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([assignedToId])
  @@index([status])
  @@index([scheduledDate])
}

enum DocumentType {
  LEASE_AGREEMENT
  ID_COPY
  PAYMENT_RECEIPT
  MAINTENANCE_REPORT
  INSPECTION_REPORT
  OTHER
}

model Document {
  id String @id @default(cuid())

  name String
  type DocumentType

  url      String
  fileSize Int?
  mimeType String?

  userId     String?
  propertyId String?

  uploadedAt DateTime @default(now())

  @@index([userId])
  @@index([propertyId])
  @@index([type])
}

enum NotificationType {
  PAYMENT_DUE
  PAYMENT_RECEIVED
  MAINTENANCE_REQUEST
  INCIDENT_REPORTED
  LEASE_EXPIRING
  SUBSCRIPTION_EXPIRING
  GENERAL
}

model Notification {
  id String @id @default(cuid())

  userId String

  type    NotificationType
  title   String
  message String

  read   Boolean   @default(false)
  readAt DateTime?

  link String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}
